@model DataAccessLayer.Models.User
@{
}

@{
    ViewData["Title"] = "Профиль";
}

<head>
    <link rel="stylesheet" href="~/css/profile.css">
</head>
<body>

    <!-- Шапка (логотип, кнопки, язык и т.д.) -->
    <div class="head__part">
        <!-- Левая пустая колонка -->
        <div>
            <a href="@Url.Action("SelectMode", "Home")" class="back-button">
                <svg class="back-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                </svg>
                Назад
            </a>
        </div>

        <!-- Логотип по центру -->
        <div></div>

        <!-- Правая колонка (пример - селектор языка) -->
        <div class="settings">
            <div class="language-selector">
@*                 <div class="selected-flag" style="background-image: url('/img/flag-en.png');"></div>
                <div class="flag-dropdown">
                    <img src="/img/flag-ru.png" alt="Russian" />
                    <img src="/img/flag-en.png" alt="English" />
                </div> *@
            </div>
        </div>
    </div>

    <!-- Main content -->
    <main class="profile-main">
        <!-- Profile Information Card -->
        <div class="profile-card">
            <h2 class="profile-card-title">Профиль пользователя</h2>

            <form id="profileForm" asp-controller="Profile" asp-action="UpdateProfile" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <!-- Avatar upload -->
                <div class="avatar-upload">
                    <div class="avatar-edit">
                        <input type="file" accept="image/*" id="avatar" name="avatar">
                        <label for="avatar">
                            <svg class="img-edit" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                            </svg>
                        </label>
                    </div>
                    <div class="avatar-preview">
                        <div id="imagePreview">
                            <img src="@ViewBag.ProfilePicture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        </div>
                    </div>
                </div>

                <div class="profile-divider"></div>

                <!-- Name input -->
                <div class="profile-input-group">
                    <label class="profile-label" for="userName">Имя</label>
                    <input type="text" id="userName" name="Name" class="profile-input" placeholder="Ваше имя" value="@ViewBag.Name" required>
                </div>

                <!-- Email input -->
                <div class="profile-input-group">
                    <label class="profile-label" for="userEmail">Email</label>
                    <input type="email" id="userEmail" name="Email" class="profile-input" placeholder="Ваш email" value="@ViewBag.Email" required>
                </div>

                <!-- Save button -->
                <button type="submit" class="profile-button">
                    Сохранить изменения
                </button>
            </form>
        
        </div>

        <!-- Security Card -->
        <div class="profile-card">
            <h2 class="profile-card-title">Безопасность</h2>

            <form asp-action="ChangePassword" asp-controller="Profile" id="securityForm">
                <!-- Current password -->
                <div class="profile-input-group">
                    <label class="profile-label" for="currentPassword">Текущий пароль</label>
                    <input type="password" name="CurrentPassword" id="currentPassword" class="profile-input" placeholder="Введите текущий пароль" required>
                </div>

                <!-- New password -->
                <div class="profile-input-group">
                    <label class="profile-label" for="newPassword">Новый пароль</label>
                    <input type="password" name="NewPassword" id="newPassword" class="profile-input" placeholder="Введите новый пароль" required>
                </div>

                <!-- Confirm password -->
                <div class="profile-input-group">
                    <label class="profile-label" for="confirmPassword">Подтверждение пароля</label>
                    <input type="password" name="ConfirmPassword" id="confirmPassword" class="profile-input" placeholder="Повторите новый пароль" required>
                </div>

                <div class="profile-divider"></div>

                <!-- 2FA Section -->
                <div class="twofa-section">
                    <h5>Двухфакторная аутентификация</h5>
                    <p>При входе вам потребуется ввести код безопасности, предложенный аутентификатором.</p>

                    @if (Model.TwoFactorEnabled)
                    {
                        <!-- Если 2FA включена – кнопка для отключения -->
                        <button type="button" id="button-cancel" class="profile-button" onclick="disable2FA()">
                            Отключить
                        </button>
                    }
                    else
                    {
                        <!-- Если 2FA не включена – кнопка для включения (открывает модальное окно) -->
                        <button type="button" class="profile-button" id="toggle2FA">
                            Включить 2FA
                        </button>
                    }
                </div>

                <!-- Save security button -->
                <button type="submit" class="profile-button">
                    Сохранить изменения
                </button>
            </form>
        </div>

        <!-- Additional Options Card -->
        <div class="profile-card">
            <h2 class="profile-card-title">Дополнительно</h2>

            <button type="button" class="profile-button" id="showHistoryBtn">
                История игр
            </button>

            <a href="@Url.Action("PrivacyPolicy", "Home")" class="profile-button">
                Политика конфиденциальности
            </a>

            <a href="@Url.Action("CookiesPolicy", "Home")" class="profile-button">
                Политика Cookies
            </a>

            <a href="@Url.Action("TermsOfUse", "Home")" class="profile-button">
                Правила использования
            </a>
        </div>
    </main>

</body>
<!-- Подключаем jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Скрипт для смены аватара с превью -->
<script src="~/js/avatar.js" defer></script>
<!-- Скрипт 2FA -->
<script src="~/js/twofa.js" defer></script>
<!--Логика смены пароля и проверки в реальном времени-->
@* <script src="~/js/password-change.js"></script> *@
<!--Логика форм профиля-->
<script src="~/js/profile.js" defer></script>


<!-- 2FA Modal -->
<div id="twoFAModal" class="profile-modal">
    <div class="profile-modal-content">
        <div class="profile-modal-header">
            <h3 class="profile-modal-title">Подключение 2FA</h3>
            <button class="profile-modal-close" onclick="closeModal('twoFAModal')">&times;</button>
        </div>

        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 20px;">
            Для включения двухфакторной аутентификации:
        </p>
        <ol style="color: rgba(255, 255, 255, 0.7); margin-bottom: 30px; padding-left: 20px;">
            <li>Установите приложение Google Authenticator</li>
            <li>Отсканируйте QR-код или введите код вручную</li>
            <li>Введите полученный 6-значный код</li>
        </ol>

        <div style="text-align: center; margin-bottom: 20px;">
            <img src="@ViewBag.QrCodeImageUrl" alt="Qr" style="width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.5);" />
        </div>

        <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px; text-align: center;">
            Или введите вручную: <strong style="color: #41CAC2;">@ViewBag.SecretKey</strong>
        </p>

        <div class="profile-input-group">
            <label class="profile-label" for="verificationCode">Код подтверждения</label>
            <input type="text" id="verificationCode" class="profile-input" placeholder="000000">
        </div>

        <button type="button" class="profile-button profile-button-2fa" onclick="verify2FA()">
            Подтвердить
        </button>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="profile-modal">
    <div class="profile-modal-content">
        <div class="profile-modal-header">
            <h3 class="profile-modal-title">История игр</h3>
            <button class="profile-modal-close" onclick="closeModal('historyModal')">&times;</button>
        </div>

        <table class="profile-table">
            <thead>
                <tr>
                    <th>Тип викторины</th>
                    <th>Очки</th>
                    <th>Дата игры</th>
                    <th>Место</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.QuizResults != null && (ViewBag.QuizResults as List<DataAccessLayer.Models.QuizResult>).Any())
                {
                    foreach (var result in ViewBag.QuizResults as List<DataAccessLayer.Models.QuizResult>)
                    {
                        <tr>
                            <td>@result.Type</td>
                            <td>@result.Score</td>
                            <td>@result.DatePlayed.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>@(result.Place.HasValue? result.Place.Value.ToString() : "-")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" style="text-align:center;">Нет результатов</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>